language:
  - cpp
  - python
python:
  - "2.7"
compiler:
  - gcc
env:
  - ROS_DISTRO=hydro

notifications:
  - email: false
sudo: required

before_install:
  - CI_SOURCE_PATH=$(pwd)
  - REPOSITORY_NAME=${PWD##*/}
  - echo "Testing branch $TRAVIS_BRANCH of $REPOSITORY_NAME"
  - sudo pip install codecov
  
install:
  - source <(wget -O- https://raw.githubusercontent.com/tue-robotics/tue-env/master/installer/scripts/bootstrap-ros-$ROS_DISTRO)
  - tue-get install ros-challenge_test
  - tue-get install ros-challenge_manipulation
  - tue-get install ros-challenge_navigation
  - tue-get install ros-challenge_person_recognition
  - tue-get install ros-challenge_rips
  - tue-get install ros-challenge_robonurse
  - tue-get install ros-speech_recognition
  - tue-get install ros-challenge_manipulation
  - source ~/.tue/setup.bash # source all target setup files
  - echo "This is an ugly hack, directly patching a file"
  - cd /opt/ros/$ROS_DISTRO/lib/python2.7/dist-packages/smach_ros
  - sudo rm simple_action_state.py #Replace the original with Loys patch
  - sudo wget https://raw.githubusercontent.com/LoyVanBeek/executive_smach/indigo-devel/smach_ros/src/smach_ros/simple_action_state.py

before_script:
  - cd ${TUE_SYSTEM_DIR}/src
  - export ROBOT_ENV=robotics_testlabs
  # Link the repo we are testing to the new workspace
  - rm -rf $REPOSITORY_NAME
  - ln -s $CI_SOURCE_PATH .
  - ls -l
  - cd .. # go to the catkin workspace

script:
  - catkin_make -j2
  - catkin_make install   # installing the package
  - catkin_make tests     # build the tests
  - roscore >> /dev/null & #Set up a roscore to run the tests with
  - catkin_make run_tests # and run them
  - rosrun tf_server tf_server >> /dev/null & #Robot keeps waiting for this
  - roscd tue_robocup
  - ./open_door.sh  >> /dev/null & #Make it look that the door is open so we can drive in. Its a bit hacky
  -
  - roscd challenge_manipulation
  - rosrun challenge_manipulation manipulation.py mockbot
  - 
  - roscd challenge_navigation
  - rosrun challenge_navigation challenge_navigation.py mockbot
  - 
  - roscd challenge_person_recognition
  - rosrun challenge_person_recognition person_recognition mockbot
  - 
  - roscd challenge_rips
  - rosrun challenge_rips rips.py mockbot
  - 
  - roscd challenge_robonurse
  - rosrun challenge_robonurse challenge_robonurse.py mockbot
  - 
  - roscd challenge_speech_recognition
  - rosrun challenge_speech_recognition 1_direct_speech_recognition.py mockbot
  - 
  - roscd challenge_speech_recognition
  - rosrun challenge_speech_recognition 2_indirect_speech_recognition.py mockbot
  - killall roscore #And kill the roscore afterwards
